"""
ARGPARSE LEVEL 1.2 — Optional flags

Goal:
    - root: directory to clean
    - --ext: one or more extensions to target (repeatable)
    - --recursive: scan recursively
    - --dry-run: do not delete, just print
"""

import argparse
from pathlib import Path
import sys


def normalize_ext(x: str) -> str:
    x = x.strip().lower()
    if not x:
        raise argparse.ArgumentTypeError("extension cannot be empty")
    return x if x.startswith(".") else "." + x


def main():
    parser = argparse.ArgumentParser(
        description="Level 1.2: Cleanup files by extension with safe flags."
    )

    parser.add_argument(
        "root",
        help="Root directory to scan (example: playground/out)"
    )

    parser.add_argument(
        "--ext",
        nargs="+",
        type=normalize_ext,
        default=[".tmp", ".log", ".bak"],
        help="Extensions to delete (example: --ext .tmp .log). Default: .tmp .log .bak"
    )

    parser.add_argument(
        "--recursive",
        action="store_true",
        help="Scan recursively (default: only direct files)"
    )

    parser.add_argument(
        "--dry-run",
        action="store_true",
        help="Do not delete; only print what would be deleted"
    )

    args = parser.parse_args()

    root = Path(args.root).expanduser().resolve()
    if not root.is_dir():
        print("ERROR: not a directory:", root)
        sys.exit(2)

    exts = set(args.ext)

    if args.recursive:
        iterator = root.rglob("*")
    else:
        iterator = root.iterdir()

    matched = 0
    deleted = 0
    skipped = 0

    print("Root     :", root)
    print("Exts     :", sorted(exts))
    print("Recursive:", args.recursive)
    print("Dry-run  :", args.dry_run)
    print("-" * 70)

    for p in iterator:
        if not p.is_file():
            continue

        if p.suffix.lower() not in exts:
            continue

        matched += 1
        rel = p.relative_to(root)

        if args.dry_run:
            print("[DRY] delete:", rel)
            continue

        try:
            p.unlink()
            print("deleted:", rel)
            deleted += 1
        except OSError as e:
            print("SKIP:", rel, "->", e)
            skipped += 1

    print("-" * 70)
    print("Matched:", matched)
    print("Deleted:", deleted)
    print("Skipped:", skipped)

    if args.dry_run:
        print("⚠️ Re-run without --dry-run to actually delete.")


if __name__ == "__main__":
    main()
